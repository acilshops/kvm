#!/bin/bash
# kyt-admin.sh — Menu admin untuk service "kyt"
# Fitur: 1) Ganti BOT  2) Update BOT  3) Delete BOT  4) Ganti Nama Panggilan
#        5) Tambah Admin  6) Edit Bot Token  7) List Admin  8) Remove Admin
#        9) Switch ON/OFF Bot  10) Restart Bot
# Jalankan sebagai root.

set -euo pipefail

# ===== Konfigurasi Utama =====
SERVICE_NAME="kyt"
VAR_DIR="/usr/bin/kyt"
VAR_FILE="$VAR_DIR/var.txt"
TELE_FILE="/etc/tele"
PER_DIR="/etc/per"
PERLOGIN_DIR="/etc/perlogin"
PER_TOKEN="$PER_DIR/token"
PER_ID="$PER_DIR/id"
PERLOGIN_TOKEN="$PERLOGIN_DIR/token"
PERLOGIN_ID="$PERLOGIN_DIR/id"
TOKEN_COPY1="/usr/bin/token"
IDCHAT_COPY1="/usr/bin/idchat"
DOMAIN_FILE="/etc/xray/domain"

# Warna
COLOR1='\033[1;36m'
COLBG1='\033[44;1m'
NC='\033[0m'
RED='\033[0;31m'
WH='\033[1;37m'
grenbo='\e[92;1m'

ensure_files() {
  mkdir -p "$VAR_DIR" "$PER_DIR" "$PERLOGIN_DIR"
  touch "$VAR_FILE" "$PER_TOKEN" "$PER_ID" "$PERLOGIN_TOKEN" "$PERLOGIN_ID" "$TOKEN_COPY1" "$IDCHAT_COPY1"
  touch "$TELE_FILE"
}

service_status() {
  local st en
  st=$(systemctl is-active "$SERVICE_NAME" 2>/dev/null || true)
  en=$(systemctl is-enabled "$SERVICE_NAME" 2>/dev/null || true)
  echo "Status: active=$st, enabled=$en"
}

# ========= OPSI 0: Install Bot (dipanggil otomatis jika /usr/bin/kyt tak ada) =========
install_bot() {
  apt update -y && apt upgrade -y
  apt install -y python3 python3-pip git speedtest-cli p7zip-full unzip curl wget

  cd /usr/bin
  clear
  wget -q https://raw.githubusercontent.com/AngIMAN/juall/main/bot/bot.zip -O bot.zip
  unzip -o bot.zip >/dev/null
  mv -f bot/* /usr/bin
  chmod +x /usr/bin/*
  rm -rf bot.zip bot

  clear
  wget -q https://raw.githubusercontent.com/AngIMAN/juall/main/bot/kyt.zip -O kyt.zip
  unzip -o kyt.zip >/dev/null
  pip3 install -r kyt/requirements.txt >/dev/null 2>&1 || true

  cd /usr/bin/kyt/bot
  chmod +x *
  mv -f * /usr/bin
  rm -rf /usr/bin/kyt/bot /usr/bin/*.zip
  cd
  rm -rf /etc/tele

  echo -e "$COLOR1╭═════════════════════════════════════════════════╮${NC}"
  echo -e "$COLOR1 ${NC} ${COLBG1}                ${WH}• BOT PANEL •                  ${NC} $COLOR1 $NC"
  echo -e "$COLOR1╰═════════════════════════════════════════════════╯${NC}"
  echo -e "$COLOR1╭═════════════════════════════════════════════════╮${NC}"
  echo -e "${grenbo}Tutorial Create Bot dan ID Telegram${NC}"
  echo -e "${grenbo}[*] Create Bot & Token : @BotFather${NC}"
  echo -e "${grenbo}[*] Info ID Telegram : @MissRose_bot → /info${NC}"
  echo -e "$COLOR1╰═════════════════════════════════════════════════╯${NC}"
  echo ""

  ensure_files
  read -e -p "[*] Input your Bot Token : " bottoken
  read -e -p "[*] Input Your Id Telegram : " admin
  domain=$(cat "$DOMAIN_FILE" 2>/dev/null || echo "")

  # Tulis var.txt (perhatikan: di contoh asal ada token hardcode—di sini kita pakai input user)
  cat > "$VAR_FILE" <<EOF
BOT_TOKEN="$bottoken"
ADMIN="$admin"
DOMAIN="$domain"
EOF

  # Notifikasi bawaan
  echo 'TEXT=$'"(cat /etc/notiftele 2>/dev/null)"'' > "$TELE_FILE" || true
  echo "TIMES=10" >> "$TELE_FILE"
  echo 'KEY=$'"(cat /etc/per/token 2>/dev/null)"'' >> "$TELE_FILE" || true

  printf '%s\n' "$bottoken" | tee "$PER_TOKEN" "$TOKEN_COPY1" "$PERLOGIN_TOKEN" >/dev/null
  printf '%s\n' "$admin"     | tee "$PER_ID" "$IDCHAT_COPY1" "$PERLOGIN_ID"   >/dev/null

  # cron pengecek service
  cat > /etc/cron.d/cekbot << 'ENDC'
SHELL=/bin/sh
PATH=/usr/local/sbin:/usr/local/bin:/sbin:/bin:/usr/sbin:/usr/bin
*/1 * * * * root /usr/bin/cekbot
ENDC

  cat > /usr/bin/cekbot << 'END'
nginx=$( systemctl status kyt | grep Active | awk '{print $3}' | sed 's/(//g' | sed 's/)//g' )
if [[ $nginx == "running" ]]; then
    echo -ne
else
    systemctl restart kyt
    systemctl start kyt
fi

kyt=$( systemctl status kyt | grep "TERM" | wc -l )
if [[ $kyt == "0" ]]; then
    echo -ne
else
    systemctl restart kyt
    systemctl start kyt
fi
END
  chmod +x /usr/bin/cekbot

  # Service
  cat > /etc/systemd/system/$SERVICE_NAME.service << 'SYS'
[Unit]
Description=Simple kyt - @kyt
After=syslog.target network-online.target

[Service]
WorkingDirectory=/usr/bin
ExecStart=/usr/bin/python3 -m kyt
Restart=on-failure

[Install]
WantedBy=multi-user.target
SYS

  systemctl daemon-reload
  systemctl enable "$SERVICE_NAME" >/dev/null 2>&1 || true
  systemctl start "$SERVICE_NAME" || true
  systemctl restart "$SERVICE_NAME" || true

  # helper trgo (ikut skrip asal)
  wget -q -O /usr/bin/addtrgo   "https://raw.githubusercontent.com/AngIMAN/juall/main/trgo/addtrgo.sh" && chmod +x /usr/bin/addtrgo
  wget -q -O /usr/bin/deltrgo   "https://raw.githubusercontent.com/AngIMAN/juall/main/trgo/deltrgo.sh" && chmod +x /usr/bin/deltrgo
  wget -q -O /usr/bin/cektrgo   "https://raw.githubusercontent.com/AngIMAN/juall/main/trgo/cektrgo.sh" && chmod +x /usr/bin/cektrgo
  wget -q -O /usr/bin/renewtrgo "https://raw.githubusercontent.com/AngIMAN/juall/main/trgo/renewtrgo.sh" && chmod +x /usr/bin/renewtrgo

  echo "Done — Installations complete, type /menu on your bot"
}

# ========= OPSI 1: Ganti BOT =========
menu_ganti_bot() {
  clear
  echo -e "$COLOR1╭═════════════════════════════════════════════════╮${NC}"
  echo -e "$COLOR1 ${NC} ${COLBG1}                ${WH}• BOT PANEL •                  ${NC} $COLOR1 $NC"
  echo -e "$COLOR1╰═════════════════════════════════════════════════╯${NC}"
  echo -e "$COLOR1╭═════════════════════════════════════════════════╮${NC}"
  echo -e "${grenbo}Tutorial Create Bot dan ID Telegram${NC}"
  echo -e "${grenbo}[*] Create Bot & Token : @BotFather${NC}"
  echo -e "${grenbo}[*] Info ID Telegram : @MissRose_bot → /info${NC}"
  echo -e "$COLOR1╰═════════════════════════════════════════════════╯${NC}"
  echo ""

  ensure_files
  read -e -p "[*] Input your Bot Token : " bottoken
  read -e -p "[*] Input Your Id Telegram : " admin
  domain=$(cat "$DOMAIN_FILE" 2>/dev/null || echo "")

  cat > "$VAR_FILE" <<EOF
BOT_TOKEN="$bottoken"
ADMIN="$admin"
DOMAIN="$domain"
EOF

  printf '%s\n' "$bottoken" | tee "$PER_TOKEN" "$TOKEN_COPY1" "$PERLOGIN_TOKEN" >/dev/null
  printf '%s\n' "$admin"     | tee "$PER_ID" "$IDCHAT_COPY1" "$PERLOGIN_ID"   >/dev/null

  # service file
  cat > /etc/systemd/system/$SERVICE_NAME.service << 'SYS'
[Unit]
Description=Simple kyt - @kyt
After=syslog.target network-online.target

[Service]
WorkingDirectory=/usr/bin
ExecStart=/usr/bin/python3 -m kyt
Restart=on-failure

[Install]
WantedBy=multi-user.target
SYS

  systemctl daemon-reload
  systemctl stop "$SERVICE_NAME" || true
  systemctl enable "$SERVICE_NAME" >/dev/null 2>&1 || true
  systemctl start "$SERVICE_NAME"
  systemctl restart "$SERVICE_NAME"

  echo "Done — Installations complete, type /menu on your bot"
  read -n 1 -s -r -p "Press any key to return..."
}

# ========= OPSI 2: Update BOT =========
menu_update_bot() {
  clear
  ensure_files
  cp -f "$VAR_FILE" /usr/bin/var.txt 2>/dev/null || true
  rm -rf /usr/bin/kyt.zip /usr/bin/kyt
  sleep 1
  cd /usr/bin

  wget -q https://raw.githubusercontent.com/AngIMAN/juall/main/bot/bot.zip -O bot.zip
  unzip -o bot.zip >/dev/null
  mv -f bot/* /usr/bin
  chmod +x /usr/bin/* || true
  rm -rf bot.zip bot

  wget -q https://raw.githubusercontent.com/AngIMAN/juall/main/bot/kyt.zip -O kyt.zip
  unzip -o kyt.zip >/dev/null
  cd kyt
  pip3 install -r kyt/requirements.txt >/dev/null 2>&1 || true
  cd /usr/bin/kyt/bot
  chmod +x *
  mv -f * /usr/bin
  rm -rf /usr/bin/kyt/bot /usr/bin/*.zip
  mv -f /usr/bin/var.txt "$VAR_FILE" 2>/dev/null || true
  cd

  systemctl daemon-reload
  systemctl stop "$SERVICE_NAME" || true
  systemctl enable "$SERVICE_NAME" >/dev/null 2>&1 || true
  systemctl start "$SERVICE_NAME"
  systemctl restart "$SERVICE_NAME"

  echo "Success Update BOT Telegram"
  read -n 1 -s -r -p "Press any key to return..."
}

# ========= OPSI 3: Delete BOT =========
menu_delete_bot() {
  clear
  rm -rf /usr/bin/kyt
  echo "Success Delete BOT Telegram"
  read -n 1 -s -r -p "Press any key to return..."
}

# ========= OPSI 4: Ganti Nama Panggilan (Multi Server) =========
menu_ganti_nama_panggilan() {
  clear
  echo -e "$COLOR1╭═════════════════════════════════════════════════╮${NC}"
  echo -e "$COLOR1 ${NC} ${COLBG1}                ${WH}• BOT PANEL •                  ${NC} $COLOR1 $NC"
  echo -e "$COLOR1╰═════════════════════════════════════════════════╯${NC}"
  echo -e "$COLOR1╭═════════════════════════════════════════════════╮${NC}"
  echo -e "${grenbo}Pakai 1 bot untuk banyak server (rename command trigger)${NC}"
  echo -e "$COLOR1╰═════════════════════════════════════════════════╯${NC}"
  echo ""
  read -e -p "[*] Input Nama Panggilan Botnya : " namabot

  sed -i "s/77/${namabot}/g" /usr/bin/kyt/modules/menu.py  2>/dev/null || true
  sed -i "s/77/${namabot}/g" /usr/bin/kyt/modules/start.py 2>/dev/null || true
  sed -i "s/\"sshovpn\"/\"sshovpn${namabot}\"/g" /usr/bin/kyt/modules/menu.py || true
  sed -i "s/\"vmess\"/\"vmess${namabot}\"/g"     /usr/bin/kyt/modules/menu.py || true
  sed -i "s/\"vless\"/\"vless${namabot}\"/g"     /usr/bin/kyt/modules/menu.py || true
  sed -i "s/\"trojan\"/\"trojan${namabot}\"/g"   /usr/bin/kyt/modules/menu.py || true
  sed -i "s&.menu|/menu&.${namabot}|/${namabot}&g"            /usr/bin/kyt/modules/menu.py  || true
  sed -i "s&.start|/start&.start${namabot}|/start${namabot}&g" /usr/bin/kyt/modules/start.py || true
  sed -i "s&.admin|/admin&.admin${namabot}|/admin${namabot}&g" /usr/bin/kyt/modules/admin.py || true
  sed -i "s/b'start'/b'start${namabot}'/g" /usr/bin/kyt/modules/start.py  || true
  sed -i "s/b'admin'/b'admin${namabot}'/g" /usr/bin/kyt/modules/admin.py  || true
  sed -i "s/b'menu'/b'${namabot}'/g"       /usr/bin/kyt/modules/menu.py   || true
  sed -i "s/b'menu'/b'${namabot}'/g"       /usr/bin/kyt/modules/start.py  || true
  sed -i "s/add-ip/add-ip${namabot}/g"     /usr/bin/kyt/modules/admin.py  || true
  sed -i "s/change-ip/change-ip${namabot}/g" /usr/bin/kyt/modules/admin.py || true
  sed -i "s/add-key/add-key${namabot}/g"   /usr/bin/kyt/modules/admin.py  || true
  sed -i "s/7-/${namabot}-/g"              /usr/bin/kyt/modules/vmess.py  || true
  sed -i "s/b'vmess'/b'vmess${namabot}'/g" /usr/bin/kyt/modules/vmess.py  || true
  sed -i "s/7-/${namabot}-/g"              /usr/bin/kyt/modules/vless.py  || true
  sed -i "s/b'vless'/b'vless${namabot}'/g" /usr/bin/kyt/modules/vless.py  || true
  sed -i "s/7-/${namabot}-/g"              /usr/bin/kyt/modules/trojan.py || true
  sed -i "s/b'trojan'/b'trojan${namabot}'/g" /usr/bin/kyt/modules/trojan.py || true
  sed -i "s/7-/${namabot}-/g"              /usr/bin/kyt/modules/ssh.py    || true
  sed -i "s/b'sshovpn'/b'sshovpn${namabot}'/g" /usr/bin/kyt/modules/ssh.py  || true
  sed -i "s/\"menu\"/\"${namabot}\"/g"     /usr/bin/kyt/modules/vmess.py  || true
  sed -i "s/\"menu\"/\"${namabot}\"/g"     /usr/bin/kyt/modules/vless.py  || true
  sed -i "s/\"menu\"/\"${namabot}\"/g"     /usr/bin/kyt/modules/trojan.py || true
  sed -i "s/\"menu\"/\"${namabot}\"/g"     /usr/bin/kyt/modules/ssh.py    || true
  sed -i "s/\"menu\"/\"${namabot}\"/g"     /usr/bin/kyt/modules/menu.py   || true

  systemctl restart "$SERVICE_NAME" || true
  echo -e "Sukses ganti nama panggilan. Panggil menu: .${namabot} atau /${namabot}"
  echo -e "Start: .start${namabot} atau /start${namabot}"
  read -n 1 -s -r -p "Press any key to return..."
}

# ========= OPSI 5: Tambah Admin =========
menu_tambah_admin() {
  clear
  ensure_files
  read -e -p "[*] Input ID Telegram user: " user
  userke=$(grep -E '^USER[0-9]+=' "$VAR_FILE" | wc -l)
  userke=$((userke+1))

  # sisipkan trik sed sesuai skrip asal (insert ke __init__.py)
  sed -i '/(ADMIN,))/a hello\tc.execute("INSERT INTO admin (user_id) VALUES (?)",(USER'"$userke"',))' /usr/bin/kyt/__init__.py 2>/dev/null || true
  cat >> "$VAR_FILE" <<EOF
USER${userke}="$user"
EOF
  sed -i "s/hello//g" /usr/bin/kyt/__init__.py 2>/dev/null || true

  # tambah notifikasi ke /etc/tele
  echo "curl -s --max-time \$TIMES -d \"chat_id=${user}&disable_web_page_preview=1&text=\$TEXT&parse_mode=html\" https://api.telegram.org/bot\$KEY/sendMessage >/dev/null" >> "$TELE_FILE"

  rm -rf /usr/bin/ddsdswl.session /usr/bin/kyt/database.db 2>/dev/null || true
  systemctl restart "$SERVICE_NAME" || true

  echo "Sukses tambah admin bot Telegram"
  read -n 1 -s -r -p "Press any key to return..."
}

# ========= OPSI 6: Edit Bot Token =========
menu_edit_token() {
  ensure_files
  echo ""
  read -e -p "[*] Masukkan Bot Token baru : " NEW_TOKEN
  # escape untuk sed
  ESCAPED=$(printf '%s' "$NEW_TOKEN" | sed -e 's/[\/&\\]/\\&/g')

  if grep -q '^BOT_TOKEN=' "$VAR_FILE"; then
    sed -i "s|^BOT_TOKEN=.*|BOT_TOKEN=\"${ESCAPED}\"|g" "$VAR_FILE"
  else
    printf 'BOT_TOKEN="%s"\n' "$NEW_TOKEN" >> "$VAR_FILE"
  fi

  printf '%s\n' "$NEW_TOKEN" | tee "$PER_TOKEN" "$TOKEN_COPY1" "$PERLOGIN_TOKEN" >/dev/null
  echo -e "\nToken diupdate. Restarting service..."
  systemctl restart "$SERVICE_NAME" && echo "OK: $SERVICE_NAME direstart." || echo "Gagal restart $SERVICE_NAME."
  read -n 1 -s -r -p "Press any key to return..."
}

# ========= OPSI 7: List Admin =========
menu_list_admin() {
  ensure_files
  echo ""
  echo "===== DAFTAR ADMIN ====="
  MAIN_ADMIN=$(grep '^ADMIN=' "$VAR_FILE" | sed -e 's/^ADMIN="//' -e 's/"$//')
  if [ -n "$MAIN_ADMIN" ]; then
    echo "MAIN_ADMIN: $MAIN_ADMIN"
  fi
  awk -F'=' '/^USER[0-9]+="/{ gsub(/"/,"",$2); printf "%s: %s\n",$1,$2 }' "$VAR_FILE"
  echo "========================"
  service_status
  read -n 1 -s -r -p "Press any key to return..."
}

# ========= OPSI 8: Remove Admin =========
menu_remove_admin() {
  ensure_files
  echo ""
  echo "Ketik ID admin (angka Telegram) ATAU label USER-nya (mis. USER3):"
  menu_list_admin
  echo ""
  read -e -p "[*] Hapus admin (ID atau USERn): " TARGET

  USER_ID=""
  if [[ "$TARGET" =~ ^USER[0-9]+$ ]]; then
    USER_LINE=$(grep -E "^${TARGET}=\"[0-9]+\"$" "$VAR_FILE" || true)
    USER_ID=$(echo "$USER_LINE" | sed -e 's/^.*="//' -e 's/"$//')
    sed -i "/^${TARGET}=\"[0-9]\+\"$/d" "$VAR_FILE"
  else
    USER_ID="$TARGET"
    sed -i "/^USER[0-9]\+=\"${USER_ID}\"$/d" "$VAR_FILE"
  fi

  if [ -n "$USER_ID" ]; then
    sed -i "\|chat_id=${USER_ID}&|d" "$TELE_FILE" 2>/dev/null || true
  fi

  if command -v sqlite3 >/dev/null 2>&1 && [ -f /usr/bin/kyt/database.db ] && [ -n "$USER_ID" ]; then
    sqlite3 /usr/bin/kyt/database.db "DELETE FROM admin WHERE user_id='${USER_ID}';" >/dev/null 2>&1 || true
  fi

  echo "Admin dihapus (jika ada). Restarting service..."
  systemctl restart "$SERVICE_NAME" && echo "OK: $SERVICE_NAME direstart." || echo "Gagal restart $SERVICE_NAME."
  read -n 1 -s -r -p "Press any key to return..."
}

# ========= OPSI 9: Switch ON/OFF Bot =========
menu_switch_bot() {
  STATUS=$(systemctl is-active "$SERVICE_NAME" 2>/dev/null || true)
  ENABLED=$(systemctl is-enabled "$SERVICE_NAME" 2>/dev/null || true)
  echo ""
  echo "Status saat ini: active=$STATUS, enabled=$ENABLED"
  echo "[1] ON  (enable + start)"
  echo "[2] OFF (disable + stop)"
  read -p "Pilih [1/2]: " sw
  case "$sw" in
    1)
      systemctl enable "$SERVICE_NAME" >/dev/null 2>&1 || true
      systemctl start "$SERVICE_NAME" || true
      ;;
    2)
      systemctl stop "$SERVICE_NAME" || true
      systemctl disable "$SERVICE_NAME" >/dev/null 2>&1 || true
      ;;
    *)
      echo "Pilihan tidak valid."
      read -n 1 -s -r -p "Press any key to return..."
      return
      ;;
  esac
  service_status
  read -n 1 -s -r -p "Press any key to return..."
}

# ========= OPSI 10: Restart Bot =========
menu_restart_bot() {
  systemctl restart "$SERVICE_NAME" && echo "OK: $SERVICE_NAME direstart." || echo "Gagal restart $SERVICE_NAME."
  service_status
  read -n 1 -s -r -p "Press any key to return..."
}

# ========= MAIN =========
clear
if [ ! -e "/usr/bin/kyt" ]; then
  install_bot
fi

while true; do
  clear
  echo -e "$COLOR1╭══════════════════════════════════════════╮${NC}"
  echo -e "$COLOR1│ ${WH}Silakan pilih menu${NC}                            $COLOR1│${NC}"
  echo -e "$COLOR1╰══════════════════════════════════════════╯${NC}"
  echo -e "$COLOR1╭══════════════════════════════════════════╮${NC}"
  echo -e "$COLOR1│  [ 1 ]  ${WH}GANTI BOT${NC}"
  echo -e "$COLOR1│  [ 2 ]  ${WH}UPDATE BOT${NC}"
  echo -e "$COLOR1│  [ 3 ]  ${WH}DELETE BOT${NC}"
  echo -e "$COLOR1│  [ 4 ]  ${WH}GANTI NAMA PANGGILAN BOT (MULTI SERVER)${NC}"
  echo -e "$COLOR1│  [ 5 ]  ${WH}TAMBAH ADMIN${NC}"
  echo -e "$COLOR1│  [ 6 ]  ${WH}EDIT BOT TOKEN${NC}"
  echo -e "$COLOR1│  [ 7 ]  ${WH}LIST ADMIN${NC}"
  echo -e "$COLOR1│  [ 8 ]  ${WH}REMOVE ADMIN${NC}"
  echo -e "$COLOR1│  [ 9 ]  ${WH}SWITCH ON/OFF BOT${NC}"
  echo -e "$COLOR1│  [ 10 ] ${WH}RESTART BOT${NC}"
  echo -e "$COLOR1│  [ 0 ]  ${WH}KELUAR${NC}"
  echo -e "$COLOR1╰══════════════════════════════════════════╯${NC}"
  read -p "   Pilih angka [0-10]: " choice

  case "$choice" in
    1) menu_ganti_bot ;;
    2) menu_update_bot ;;
    3) menu_delete_bot ;;
    4) menu_ganti_nama_panggilan ;;
    5) menu_tambah_admin ;;
    6) menu_edit_token ;;
    7) menu_list_admin ;;
    8) menu_remove_admin ;;
    9) menu_switch_bot ;;
    10) menu_restart_bot ;;
    0) exit 0 ;;
    *) echo "Pilihan tidak valid"; sleep 1 ;;
  esac
done
